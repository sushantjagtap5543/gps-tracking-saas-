class TripService {
  constructor(pool, redis) {
    this.pool = pool;
    this.redis = redis;
  }

  async processGpsPoint(deviceId, gpsData) {
    // Trip logic from document
    const currentTrip = await this.redis.get(`trip:${deviceId}`);
    if (gpsData.ignition && gpsData.speed > 5 && !currentTrip) {
      const tripId = uuid.v4();
      await this.pool.query('INSERT INTO trips (id, device_id, start_time) VALUES ($1, $2, NOW())', [tripId, deviceId]);
      await this.redis.set(`trip:${deviceId}`, tripId);
    } else if (!gpsData.ignition && currentTrip) {
      await this.pool.query('UPDATE trips SET end_time = NOW() WHERE id = $1', [currentTrip]);
      await this.redis.del(`trip:${deviceId}`);
    }
    // Calculate distance, etc. using postgis
  }
}

module.exports = TripService;
